<script>
	// eslint-disable-next-line node/no-unpublished-import
	import { createEventDispatcher, tick } from 'svelte';

	const dispatch = createEventDispatcher();

	export let dataType;
	export let fieldEditor;
	export let value = [];
	export let currentValue;
	export let newItemValue = null
	
	function isEmpty(target) {
		if (target === null || target === undefined || target === '') {
			return true;
		}
		if (typeof target === 'object') {
			return Object.keys(target).every(key => isEmpty(target[key]));
		}
		return false;
	}

	function add (addIfEmpty) {
		if (!currentValue) {
			currentValue = [];
		}
		if (addIfEmpty || !isEmpty(newItemValue)) {
			currentValue = [...currentValue, newItemValue];
			newItemValue = null;
			dispatch('change', currentValue);
		}
	}
	function set (id, newValue) {
		currentValue[id] = newValue;
		dispatch('change', currentValue);
	}
	function discard (id) {
		currentValue.splice(id, 1);
		currentValue = currentValue;
		dispatch('change', currentValue);
	}
	
	$: currentValue = value;
</script>

<div>
	{#if value}
	{#each value as item, id}
		<span>
			<svelte:component
				this={fieldEditor.component}
				value={item}
				{...fieldEditor.props}
				on:change={e => {
					const value = e.detail;
					if (isEmpty(value))	{
						discard(id);
					}
					else {
						set(id, value);
					}
				}}
			/>
		</span>
		<button on:click={() => discard(id)}>-</button>
	{/each}
	{/if}
	<span>
		<svelte:component
			this={null}
			value={newItemValue}
			{...fieldEditor.props}
			on:change={async e => {
				newItemValue = e.detail;
				await tick();
				add(false);
			}}
		/>
	</span>
	<button on:click={() => add(true)}>+</button>
</div>

<style>
	div{
		display: grid;
		grid-template-columns: 1fr min-content;
	}
	span {
		display: inline-block;
		position: relative;
	}
	button {
		width: 4.8em;
		height: 100%;
		font-weight: bold;
		cursor: pointer;
	}
</style>