<script>
	// eslint-disable-next-line node/no-unpublished-import
	import { createEventDispatcher } from 'svelte';
	import { autoID } from 'app/utils';

	const dispatch = createEventDispatcher();

	const id = autoID();

	export let labelText = '';
	export let dataType = 'text';
	export let value;
	export let required;

	let type;
	let fieldValue;
	let placeholder;
	let currentValue = '';

	const inputTypes = {
		date: 'date',
		'boolean': 'checkbox',
		'Opaque<Date, "date">': 'date',
		'Opaque<string, "Date_YYYYMMDD_dash">': 'date',
		'Opaque<string, "Date_YYYYMMDD_dash_time">': 'date',
		'Opaque<string, "ES_keyword">': 'text',
		'Opaque<string, "ES_text">': 'text',
		'Opaque<string, "ES_text_w_keyword">': 'text',
		'Opaque<number, "integer">': 'number',
		'Opaque<number, "float">': 'number',
		string: 'text'
	}

	function pad (num, size) {
		return `${num}`.padStart(size, '0');
	}

	function Date_YYYYMMDD_dash (date) {
		return `${date.getFullYear()}-${pad(date.getMonth() + 1, 2)}-${pad(date.getDate(), 2)}`;
	}

	function Date_YYYYMMDD_dash_time (date) {
		return `${Date_YYYYMMDD_dash(date)} ${pad(date.getHours(), 2)}:${pad(date.getMinutes(), 2)}:${pad(date.getSeconds(), 2)}`;
	}

	function incomingBoolean (incoming) {
		if (incoming === null || incoming === undefined) {
			return 'null';
		}
		return Boolean(incoming);
	}
	function outgoingBoolean (outgoing) {
		if (outgoing === 'null') {
			return null;
		}
		return outgoing;
	}

	const incomingFormatters = {
		'boolean': incomingBoolean,
		'Opaque<string, "Date_YYYYMMDD_dash">': dateString => Date_YYYYMMDD_dash(new Date(dateString)),
		'Opaque<string, "Date_YYYYMMDD_dash_time">': dateString => Date_YYYYMMDD_dash(new Date(dateString)),
	}

	const outgoingFormatters = {
		'Opaque<string, "Date_YYYYMMDD_dash">': dateString => Date_YYYYMMDD_dash(new Date(dateString)),
		'Opaque<string, "Date_YYYYMMDD_dash_time">': dateString => Date_YYYYMMDD_dash_time(new Date(dateString)),
		'Opaque<number, "integer">': parseInt,
		'Opaque<number, "float">': parseFloat,
	}

	const placeholders = {
		'Opaque<number, "integer">': 'integer',
		'Opaque<number, "float">': 'float',
		'Opaque<string, "ES_keyword">': 'text',
		'Opaque<string, "ES_text">': 'text',
		'Opaque<string, "ES_text_w_keyword">': 'text',
	}

	function computeInputType (esType) {
		return inputTypes[esType];
	}

	function formatIncomingValue (incomingValue) {
		let result;
		switch (dataType) {
			case 'boolean':
				result = incomingBoolean(incomingValue);
				break;
			default:
				if (dataType in incomingFormatters && incomingValue !== null && incomingValue !== undefined) {
					result = incomingFormatters[dataType](incomingValue)
				}
				else {
					result = incomingValue || '';
				}
		}
		return result;
	}

	function notify (payload) {
		let outgoing = payload;
		if (dataType === 'boolean') {
			outgoing = outgoingBoolean(payload);
		}
		else if (dataType in outgoingFormatters) {
			outgoing = outgoing.length > 0
				? outgoingFormatters[dataType](outgoing)
				: null;
		}
		dispatch('change', outgoing);
	}

	function handleChange (event) {
		notify(event.target.value);
	}

	function handleInput (event) {
		currentValue = event.target.value;
		// TODO Perhaps we need to handle validation as well
	}

	function computePlaceHolder (newDataType) {
		if (newDataType in placeholders) {
			return placeholders[newDataType];
		}
		return newDataType;
	}

	$: placeholder = computePlaceHolder(dataType);
	$: fieldValue = formatIncomingValue(value);
	$: type = computeInputType(dataType);
	$: dataType === 'boolean' && notify(fieldValue)
</script>

<label for={id}>{labelText}</label>
{#if dataType !== 'boolean'}
	<input {id} {type} value={fieldValue} 
		on:change={handleChange}
		on:input={handleInput}
		{placeholder}
		class:required
		class:empty={currentValue === ''}
	>
{:else if dataType === 'boolean'}
<div>
	<input id={`${id}-unset`} type='radio' bind:group={fieldValue} value={'null'}>
	<label for={`${id}-unset`} class='boolean-state'>Unset</label>
	<input id={`${id}-true`} type='radio' bind:group={fieldValue} value={true}>
	<label for={`${id}-true`} class='boolean-state'>True</label>
	<input id={`${id}-false`} type='radio' bind:group={fieldValue} value={false}>
	<label for={`${id}-false`} class='boolean-state'>False</label>
</div>
{/if}

<style>
label:not(.boolean-state) {
	justify-self: end;
}
input:not([type='checkbox']):not([type='date']):not([type='radio']) {
	width: 100%;
}
.required.empty {
	border-color: red;
}
ul {
	list-style-type: none;
}
</style>
