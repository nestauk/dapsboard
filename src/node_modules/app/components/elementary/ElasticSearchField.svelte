<script>
	// eslint-disable-next-line node/no-unpublished-import
	import { createEventDispatcher } from 'svelte';
	import IconHelpCircle from 'app/components/icons/IconHelpCircle.svelte';

	import { autoID } from 'app/utils';

	import SimpleField from './SimpleField.svelte';
	// import DateTimeField from './SimpleField.svelte';
	import BooleanRadios from './BooleanRadios.svelte';
	import MinMax from './MinMax.svelte';
	import EsGeoPointObj from './EsGeoPointObj.svelte';
	import ObjectEditor from './ObjectEditor.svelte';
	import RadioList from './RadioList.svelte';
	import DateInterval from './DateInterval.svelte';
	import ExistenceEditor from './ExistenceEditor.svelte';

	const dispatch = createEventDispatcher();

	const id = autoID();

	const typeEditors = {
		'boolean': {
			component: BooleanRadios
		},
		'Opaque<number, "integer">': {
			component: SimpleField,
			props: {
				type: 'number',
				dataType: 'integer'
			}
		},
		'Opaque<number, "float">': {
			component: SimpleField,
			props: {
				type: 'number',
				dataType: 'float'
			}
		},
		'Opaque<string, "ES_keyword">': {
			component: SimpleField,
			props: {
				type: 'text',
				dataType: 'ES_keyword'
			}
		},
		'Opaque<string, "ES_text">': {
			component: SimpleField,
			props: {
				type: 'text',
				dataType: 'ES_text'
			}
		},
		'Opaque<string, "ES_text_w_keyword">': {
			component: SimpleField,
			props: {
				type: 'text',
				dataType: 'ES_text_w_keyword'
			}
		},
		'string': {
			component: SimpleField,
			props: {
				type: 'text',
				dataType: 'string'
			}
		},
		'date': {
			component: SimpleField,
			props: {type: 'date'}
		},
		'Opaque<Date, "date">': {
			component: SimpleField,
			props: {type: 'date'}
		},
		'Opaque<string, "Date_YYYYMMDD_dash">': {
			component: SimpleField,
			props: {
				type: 'date',
				dataType: 'Date_YYYYMMDD_dash'
			}
		},
		'Opaque<string, "Date_YYYYMMDD_dash_time">': {
			component: SimpleField,
			props: {
				type: 'date',
				dataType: 'Date_YYYYMMDD_dash'
			}
		},
		'MinMax<Opaque<number, "integer">>': {
			component: MinMax,
			props: {
				dataType: 'integer'
			}
		},
		'MinMax<Opaque<number, "float">>': {
			component: MinMax,
			props: {
				dataType: 'float'
			}
		},
		'ES_geo_point_obj': {
			component: EsGeoPointObj,
			props: {
				type: 'number',
				dataType: 'float'
			}
		},
		'DateInterval': {
			component: DateInterval,
			props: {
				dataType: "DateInterval"
			}
		},
		'Opaque<object, "existence">': {
			component: ExistenceEditor,
			props: {
				dataType: 'existence'
			}
		},

	}

	export let labelText = '';
	export let dataType = 'text';
	export let value = null;
	export let defaultValue;
	export let required = false;
	export let help = true;

	let editor;

	function displayDocs () {
		dispatch('docs', 'display');
	}

	function hideDocs () {
		dispatch('docs', 'hide');
	}

	function handleFocus () {
		dispatch('docs', 'set');
	}

	function handleBlur () {
		dispatch('docs', 'unset');
	}

	function handleChange (event) {
		dispatch('change', event.detail);
	}

	const stringUnionPattern = /^(['"]\w*['"]\s*\|\s*)*['"]\w*['"]$/u;
	function getEditor (targetDataType) {
		if (targetDataType in typeEditors) {
			return typeEditors[targetDataType]
		} else if (stringUnionPattern.test(targetDataType)) {
			const unionEditor = {
				component: RadioList,
				props: {
					dataType: targetDataType,
					list: targetDataType.split('|').map(i => i.trim().replaceAll('"',''))
				}
			};
			return unionEditor;
		}
		else if (targetDataType.endsWith('[]')) {
			const arrayEditor = {
				component: SimpleField,
				props: {
					dataType: targetDataType,
				}
			}
			return arrayEditor;
		}
		return  {
			component: ObjectEditor,
			props: {
				type: 'json',
				dataType: targetDataType
			}
		};
	}

	$: editor = getEditor(dataType);
</script>

<label
	for={id}
	on:mouseover={displayDocs}
	on:mouseout={hideDocs}
	title={dataType}
	class:inline={stringUnionPattern.test(dataType) || dataType === 'boolean'}
>
	{labelText}
	{#if help}
		<IconHelpCircle size={14} />
	{/if}
</label>
<div
	on:mouseover={displayDocs}
	on:mouseout={hideDocs}
>
	{#if editor}
		<svelte:component 
			this={editor.component} 
			{value}
			{id}
			{defaultValue}
			{required}
			on:change={handleChange}
			on:focus={handleFocus}
			on:blur={handleBlur}
			{...editor.props}
		/>
	{/if}
</div>

<style>
	label {
		white-space: nowrap;
		justify-self: end;
	}
	.inline {
		float: left;
		margin-right: 1em;
		font-weight: bold;
		width: 25%;
	}
</style>
