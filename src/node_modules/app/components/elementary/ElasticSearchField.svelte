<script>
	// eslint-disable-next-line node/no-unpublished-import
	import { createEventDispatcher } from 'svelte';
	import { autoID } from 'app/utils';

	const dispatch = createEventDispatcher();

	const id = autoID();

	export let labelText = '';
	export let dataType = 'text';
	export let value;
	export let required;

	let type;
	let fieldValue;
	let outgoingValue = null;
	let placeholder;
	let currentValue = '';
	let booleanInput;

	const inputTypes = {
		date: 'date',
		'boolean': 'checkbox',
		'Opaque<Date, "date">': 'date',
		'Opaque<string, "Date_YYYYMMDD_dash">': 'date',
		'Opaque<string, "Date_YYYYMMDD_dash_time">': 'date',
		'Opaque<string, "ES_keyword">': 'text',
		'Opaque<string, "ES_text">': 'text',
		'Opaque<string, "ES_text_w_keyword">': 'text',
		'Opaque<number, "integer">': 'number',
		'Opaque<number, "float">': 'number',
		string: 'text'
	}

	function pad (num, size) {
		return `${num}`.padStart(size, '0');
	}

	function Date_YYYYMMDD_dash (date) {
		return `${date.getFullYear()}-${pad(date.getMonth() + 1, 2)}-${pad(date.getDate(), 2)}`;
	}

	function Date_YYYYMMDD_dash_time (date) {
		return `${Date_YYYYMMDD_dash(date)} ${pad(date.getHours(), 2)}:${pad(date.getMinutes(), 2)}:${pad(date.getSeconds(), 2)}`;
	}

	const incomingFormatters = {
		'Opaque<string, "Date_YYYYMMDD_dash">': date => Date_YYYYMMDD_dash(new Date(date)),
		'Opaque<string, "Date_YYYYMMDD_dash_time">': date => Date_YYYYMMDD_dash(new Date(date)),
	}

	const outgoingFormatters = {
		'boolean': Boolean,
		'Opaque<string, "Date_YYYYMMDD_dash">': date => Date_YYYYMMDD_dash(new Date(date)),
		'Opaque<string, "Date_YYYYMMDD_dash_time">': date => Date_YYYYMMDD_dash_time(new Date(date)),
		'Opaque<number, "integer">': parseInt,
		'Opaque<number, "float">': parseFloat,
	}

	const placeholders = {
		'Opaque<number, "integer">': 'integer',
		'Opaque<number, "float">': 'float',
		'Opaque<string, "ES_keyword">': 'text',
		'Opaque<string, "ES_text">': 'text',
		'Opaque<string, "ES_text_w_keyword">': 'text',
	}

	function computeInputType (esType) {
		return inputTypes[esType];
	}

	function formatIncomingValue (incomingValue) {
		if (dataType === 'boolean') {
			return incomingValue;
		}
		if (dataType in incomingFormatters && incomingValue) {
			return incomingFormatters[dataType](incomingValue)
		}
		return incomingValue || '';
	}

	function handleClick (event) {
		event.preventDefault = true;

		if (value === null || value === undefined) {
			value = true;
		}
		else if (value === true) {
			value = false;
		}
		else {
			value = null;
		}
	}

	function handleChange (event) {
		if (dataType === 'boolean') {
			outgoingValue = value;
		}
		else {
			outgoingValue = event.target.value;
			if (dataType in outgoingFormatters) {
				outgoingValue = outgoingValue.length > 0
					? outgoingFormatters[dataType](outgoingValue)
					: null;
			}
		}
		dispatch('change', outgoingValue);
	}
	function handleInput (event) {
		currentValue = event.target.value;
		// TODO Perhaps we need to handle validation as well
	}

	function computePlaceHolder (newDataType) {
		if (newDataType in placeholders) {
			return placeholders[newDataType];
		}
		return newDataType;
	}

	$: placeholder = computePlaceHolder(dataType);
	$: fieldValue = formatIncomingValue(value);
	$: type = computeInputType(dataType);
</script>

{#if dataType !== 'boolean'}
	<label for={id}>{labelText}</label>
	<input {id} {type} value={fieldValue} 
		on:change={handleChange}
		on:input={handleInput}
		{placeholder}
		class:required
		class:empty={currentValue === ''}
	>
{:else if dataType === 'boolean'}
	<input {id} {type} bind:this={booleanInput}
		on:click={handleClick}
		on:change={handleChange}
		checked={fieldValue}
		indeterminate={fieldValue === null || fieldValue === undefined}
	>
	<label for={id} class='checkbox'>{labelText}</label>
{/if}

<style>
label {
	display:block;
}
label.checkbox {
	display: inline

}
input[type='number'],
input[type='text'] {
	width: 100%;
}
.required.empty {
	border-color: red;
}
</style>
