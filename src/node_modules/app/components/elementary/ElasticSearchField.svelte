<script>
	import { createEventDispatcher } from 'svelte';

	// import * as _ from 'lamb';
	import { isString } from '@svizzle/utils';
	import { autoID } from 'app/utils/generic';
	import {
		equalsJson,
		extractBaseType,
		hasRecord,
		isArrayObject,
		isArrayString,
		isStringLiteralUnion,
	} from 'app/elasticsearch/utils/aggParams';

	import IconHelpCircle from 'app/components/icons/IconHelpCircle.svelte';

	import ArrayEditor from './ArrayEditor.svelte';
	import BooleanRadios from './BooleanRadios.svelte';
	import QuantityEditor from 'app/components/elementary/QuantityEditor.svelte';
	import EsGeoPointObj from './EsGeoPointObj.svelte';
	import ExistenceEditor from './ExistenceEditor.svelte';
	import MinMax from './MinMax.svelte';
	import ObjectEditor from './ObjectEditor.svelte';
	import RadioList from './RadioList.svelte';
	import SimpleField from './SimpleField.svelte';

	const dispatch = createEventDispatcher();

	const id = autoID();

	const typeEditors = {
		'boolean': {
			component: BooleanRadios
		},
		'integer': {
			component: SimpleField,
			props: {
				type: 'number',
				dataType: 'integer'
			}
		},
		'float': {
			component: SimpleField,
			props: {
				type: 'number',
				dataType: 'float'
			}
		},
		'ES_keyword': {
			component: SimpleField,
			props: {
				type: 'text',
				dataType: 'ES_keyword'
			}
		},
		'ES_text': {
			component: SimpleField,
			props: {
				type: 'text',
				dataType: 'ES_text'
			}
		},
		'ES_text_w_keyword': {
			component: SimpleField,
			props: {
				type: 'text',
				dataType: 'ES_text_w_keyword'
			}
		},
		'string': {
			component: SimpleField,
			props: {
				type: 'text',
				dataType: 'string'
			}
		},
		'date': {
			component: SimpleField,
			props: {type: 'date'}
		},
		'Date_YYYYMMDD_dash': {
			component: SimpleField,
			props: {
				type: 'date',
				dataType: 'Date_YYYYMMDD_dash'
			}
		},
		'Date_YYYYMMDD_dash_time': {
			component: SimpleField,
			props: {
				type: 'date',
				dataType: 'Date_YYYYMMDD_dash'
			}
		},
		'MinMax<integer>': {
			component: MinMax,
			props: {
				dataType: 'integer'
			}
		},
		'MinMax<float>': {
			component: MinMax,
			props: {
				dataType: 'float'
			}
		},
		'ES_geo_point_obj': {
			component: EsGeoPointObj,
			props: {
				type: 'number',
				dataType: 'float'
			}
		},
		'Existence': {
			component: ExistenceEditor,
			props: {
				dataType: 'Existence'
			}
		},
	}

	export let dataType;
	export let defaultValue;
	export let help = true;
	export let labelText = '';
	export let required;
	export let typeObject;
	export let value = null;
	
	let editor;

	function displayDocs () {
		dispatch('docs', 'display');
	}

	function hideDocs () {
		dispatch('docs', 'hide');
	}

	function setDocs () {
		dispatch('docs', 'set');
	}

	function unsetDocs () {
		dispatch('docs', 'unset');
	}

	function handleChange (event) {
		dispatch('change', event.detail);
	}

	function getEditor (targetTypeObject) {
		const baseType = extractBaseType(targetTypeObject);
		if (isString(baseType) && baseType in typeEditors) {
			return typeEditors[baseType];
		} else if (isStringLiteralUnion(baseType)) {
			const unionEditor = {
				component: RadioList,
				props: {
					typeObject: baseType,
				}
			};
			return unionEditor;
		} else if (isArrayString(baseType) || isArrayObject(baseType)) {
			let subType;
			if (isArrayString(baseType)) {
				subType = baseType.substr(0, baseType.length - 2);
			} else if (isArrayObject(baseType)) {
				subType = baseType.__array;
			}
			const arrayEditor = {
				component: ArrayEditor,
				props: {
					fieldEditor: getEditor(subType)
				}
			}
			return arrayEditor;
		} else if ('__units' in baseType) {
			return {
				component: QuantityEditor,
				props: {
					unitList: baseType.__units
				}
			}
		} else if (equalsJson(baseType) || hasRecord(baseType)) {
			return {
				component: SimpleField,
				props: {
					type: 'json',
					typeObject: baseType
				}
			}
		}
		return  {
			component: ObjectEditor,
			props: {
				type: 'json',
				typeObject: baseType
			}
		};
	}
/*
	const isOf = obj => key => key in obj;
	const hasUnits = _.hasKey('__units');
	const configUnionEditor = type => ({
		component: RadioList,
		props: {
			typeObject: type,
		}
	});
	const configureArrayEditor = _.pipe(
		_.adapter(
			_.casus(isArrayString, type => type.substr(0, type.length - 2)),
			_.casus(isArrayString, _.getKey('__array'))
		),
		type => ({
			component: ArrayEditor,
			props: {
				fieldEditor: getEditor(type)
			}
		})
	);
	const configureQuantityEditor = type => ({
		component: QuantityEditor,
		props: {
			unitList: type.__units
		}
	});
	const configureJsonEditor = type => ({
		component: SimpleField,
		props: {
			type: 'json',
			typeObject: type
		}
	});
	const configureObjectEditor = type => ({
		component: ObjectEditor,
		props: {
			type: 'json',
			typeObject: type
		}
	});

	const getEditor = _.pipe(
		extractBaseType,
		_.adapter(
			_.casus(_.allOf(isString, isOf(typeEditors)), _.identity),
			_.casus(isStringLiteralUnion, configUnionEditor),
			_.casus(_.anyOf(isArrayObject, isArrayString), configureArrayEditor),
			_.casus(hasUnits, configureQuantityEditor),
			_.casus(_.anyOf(_.equalsJson, hasRecord), configureJsonEditor),
			_.always(configureObjectEditor)
		)
	);
*/
	$: editor = getEditor(typeObject);
</script>

<label
	for={id}
	on:mouseover={displayDocs}
	on:mouseout={hideDocs}
	title={dataType}
	class:inline={!help && (typeObject && isStringLiteralUnion(typeObject) || dataType === 'boolean')}
>
	{labelText}
	{#if help}
		<IconHelpCircle size={14} />
	{/if}
</label>
<div
	on:mouseover={displayDocs}
	on:mouseout={hideDocs}
>
	{#if editor}
		<svelte:component
			this={editor.component}
			{value}
			{id}
			{defaultValue}
			{required}
			on:change={handleChange}
			on:focus={setDocs}
			on:blur={unsetDocs}
			{...editor.props}
		/>
	{/if}
</div>

<style>
	label {
		white-space: nowrap;
		justify-self: end;
	}
	.inline {
		float: left;
		margin-right: 1em;
		font-weight: bold;
		width: 25%;
		min-width: min-content;
	}
</style>
