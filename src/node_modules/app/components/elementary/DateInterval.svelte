<script>
	// eslint-disable-next-line node/no-unpublished-import
	import { createEventDispatcher } from 'svelte';
	import SimpleField from './SimpleField.svelte';
	import RadioList from './RadioList.svelte';
	
	const dispatch = createEventDispatcher();

	export let id = null;
	export let dataType = null;
	export let required = false;
	export let value = null;
	export let defaultValue = null;
	
	let type;
	let numericValue;
	let unitValue;
	let defaultNumeric;
	let defaultUnit;
	let notEmpty = false;

	function extractUnitValue (v) {
		var letr = v.match(/[a-zA-Z]+/g);
		return letr && letr.length > 1 ? letr[0] : null;
	}

	const unitList = ['m', 'h', 'd', 'w', 'M', 'q', 'y'];
	function handleValueChange (newValue) {
		if (newValue) {
			numericValue = parseInt(newValue);
			unitValue = extractUnitValue(newValue);
			notEmpty = numericValue !== null || unitValue !== null;
		} else {
			numericValue = null;
			unitValue = null;
			notEmpty = false;
		}
		console.log('value changed', numericValue, unitValue);
	}
	function handleEditorChange (newValue) {
		dispatch('change', newValue);
	}
	function handleChangeNumeric (event) {
		const part = event.detail;
		const newValue = `${part !== null? part : ''}${unitValue !== null ? unitValue : ''}`;
		numericValue = event.detail;
		handleValueChange(newValue)
		handleEditorChange(newValue);
	}
	function handleChangeUnit (event) {
		const part = event.detail;
		const newValue = `${numericValue !== null? numericValue : ''}${part !== null ? part : ''}`;
		handleValueChange(newValue)
		handleEditorChange(newValue);
	}

	function handleFocus () {
		dispatch('focus');
	}
	function handleBlur () {
		dispatch('blur');
	}

	const types = {
		'integer': 'number',
		'float': 'number',
		'string': 'text',
	};
	
	$: type = types[dataType];
	$: handleValueChange(value);
	$: defaultValue && (
		defaultNumeric = parseInt(defaultValue),
		defaultUnit = extractUnitValue(defaultValue)
	) || !defaultValue && (
		defaultNumeric = undefined,
		defaultUnit = undefined
	);
</script>

<div>
	<div class='numeric'>
		<SimpleField
			id={id + '-numeric'}
			type='number'
			dataType='Opaque<number, "integer">'
			value={numericValue}
			defaultValue={defaultNumeric}
			on:change={handleChangeNumeric}
			on:focus={handleFocus}
			on:blur={handleBlur}
			required={required || notEmpty}
		/>
	</div>
	<div class='unit'>
		<RadioList
			id={id + '-unit'}
			list={unitList}
			value={unitValue}
			defaultValue={defaultUnit}
			on:change={handleChangeUnit}
			on:focus={handleFocus}
			on:blur={handleBlur}
			required={required || notEmpty}
		/>
	</div>
</div>

<style>
	div {
		display: grid;
		grid-template-areas: 'field1 field2';
		column-gap: 0.5em;
	}
	div.numeric {
		grid-area: field1;
	}
	div.unit {
		grid-area: field2;
	}
</style>