<script context='module'>
	function pad (num, size) {
		return `${num}`.padStart(size, '0');
	}

	function Date_YYYYMMDD_dash (date) {
		return `${date.getFullYear()}-${pad(date.getMonth() + 1, 2)}-${pad(date.getDate(), 2)}`;
	}
</script>

<script>
	// eslint-disable-next-line node/no-extraneous-import
	import areEqual from 'just-compare';
	// eslint-disable-next-line node/no-unpublished-import
	import { createEventDispatcher } from 'svelte';

	const dispatch = createEventDispatcher();

	export let id = null;
	export let type = 'text';
	export let dataType = 'text';
	export let value = null;
	export let defaultValue;
	export let required;

	let fieldValue;
	let currentValue = value;
	let isDefaultValue = false;

	const incomingFormatters = {
		'integer': v => v.toString(),
		'float': v => v.toString(),
		'Date_YYYYMMDD_dash': dateString =>
			Date_YYYYMMDD_dash(new Date(dateString)),
		'json': obj => obj ? JSON.stringify(obj) : null
	}

	const outgoingFormatters = {
		'integer': parseInt,
		'float': parseFloat,
		'Date_YYYYMMDD_dash': dateString =>
			Date_YYYYMMDD_dash(new Date(dateString)),
		'json': obj => {
			let result = null;
			if (obj !== null && obj !== undefined) {
				try {
					result = JSON.parse(obj);
				}
				catch (e) {
					console.log('Problem parsing JSON, aborting dispatch...', e);
				}
			}
			return result;
		}
	}

	function formatIncomingValue (incomingValue) {
		let result;
		if (
			dataType in incomingFormatters
			&& incomingValue !== null
			&& incomingValue !== undefined
		) {
			result = incomingFormatters[dataType](incomingValue);
		}
		else if (type === 'json') {
			result = incomingFormatters.json(incomingValue);
		}
		else {
			result = incomingValue || '';
		}
		return result;
	}

	function parseOutgoingValue (outgoingValue) {
		let outgoing = outgoingValue;
		if (dataType in outgoingFormatters) {
			outgoing = outgoing.length > 0
				? outgoingFormatters[dataType](outgoing)
				: null;
		}
		else if (type === 'json') {
			outgoing = outgoingFormatters.json(outgoing);
		}
		return outgoing;
	}
	
	function notify (payload) {
		dispatch('change', parseOutgoingValue(payload));
	}

	function handleFocus () {
		dispatch('docs', 'set');
	}

	function handleBlur () {
		dispatch('docs', 'unset');
	}

	function handleChange (event) {
		notify(event.target.value);
	}

	function handleInput (event) {
		currentValue = event.target.value;
		// TODO Perhaps we need to handle validation as well
	}

	function handleValueChange (newValue) {
		fieldValue = formatIncomingValue(newValue);
	}

	function handleFieldValueChange (newFieldValue) {
		currentValue = newFieldValue;
	}

	$: handleValueChange(value);
	$: handleFieldValueChange(fieldValue);
	$: isDefaultValue = areEqual(parseOutgoingValue(currentValue), defaultValue);
	$: console.log(dataType, value, fieldValue, currentValue, isDefaultValue)
</script>

<input {id} {type} value={fieldValue} 
	on:change={handleChange}
	on:input={handleInput}
	on:focus={handleFocus}
	on:blur={handleBlur}
	placeholder={dataType}
	title={dataType}
	class:required
	class:empty={currentValue === ''}
	class:default={isDefaultValue}
>

<style>
	input:not([type='checkbox']):not([type='date']):not([type='radio']) {
		width: 100%;
	}
	.required.empty {
		border-color: red;
	}
	.default {
		background-color: #fff1ff;
	}
</style>
