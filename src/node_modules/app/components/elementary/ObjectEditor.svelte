<script>
	// eslint-disable-next-line node/no-unpublished-import
	import { createEventDispatcher } from 'svelte';
	import { getParamInfo, extractBaseType } from 'app/elasticsearch';

	import ESField from './ElasticSearchField.svelte';
	import { isKeyValue } from '@svizzle/utils';
	import * as _ from 'lamb';

	const dispatch = createEventDispatcher();

	export let typeObject;
	export let defaultValue = null;
	export let editedValue = null;
	export let id = null;
	export let value = null;
	export let required = false;

	let completions = [];
	let isParamSelector = false;

	const isNameType = isKeyValue(['name', '__type']);

	const getTypings = _.pipe([
		extractBaseType,
		getParamInfo,
		_.sortWith([_.getKey('required')])
	])

	const safeGetKeyOf = obj => key => obj && obj[key];
	const getFieldValue = safeGetKeyOf(value);
	const getDefaultValue = safeGetKeyOf(defaultValue);

	function handleChange (change) {
		editedValue = {
			...editedValue,
			...change
		}
		dispatch('change', editedValue);
	}

	$: editedValue = value;
	$: completions = getTypings(typeObject);
	$: isParamSelector = completions.some(isNameType);
</script>

<div>
{#each completions as completion (`${id}-${completion.name}`)}
	{#if !isParamSelector || ['__type', value.__type].includes(completion.name)}
		<ESField
			labelText={completion.name}
			required={isParamSelector
				? required
				: required && completion.required
			}
			dataType={completion.displayText}
			typeObject={completion.type}
			value={getFieldValue(completion.name)}
			defaultValue={getDefaultValue(completion.name)}
			on:change={event => handleChange({[completion.name]: event.detail})}
			help={false}
		/>
	{/if}
{/each}
</div>

<style>
div {
	padding-left: 1em;
	border-left: 1px solid lightgray;
}
</style>
