<script context='module'>
	let datasetTypings;
</script>

<script>
	// eslint-disable-next-line node/no-unpublished-import
	import { createEventDispatcher } from 'svelte';
	import { getCompletions } from 'app/tsservices';
	import { request } from 'app/net';

	import ESField from './ElasticSearchField.svelte';

	const dispatch = createEventDispatcher();

	// export let required = false; // seems unused
	export let dataType;
	export let defaultValue = null;
	export let editedValue = null;
	export let id = null;
	export let value = null;
	export let required = false;

	let completions = [];
	let isParamSelector = false;

	async function computeTypings () {
		if ('ts' in window) {
			if (!datasetTypings) {
				datasetTypings = await request(
					'GET',
					'/dsl/datasets.ts',
					{type:'text'}
				);
			}

			const code = `const obj: ${dataType} = {};`;
			const fullCode = datasetTypings + code;
			completions = getCompletions(
				fullCode,
				fullCode.lastIndexOf('{') + 1
			)
			if (completions) {
				completions.sort((a, b) => b.required - a.required);
				isParamSelector = completions.some(completion => completion.name === '__type');
				return;
			}
			const altCode = `const obj: ${dataType} = '`;
			const fullAltCode = datasetTypings + altCode;
			completions = getCompletions(
				fullAltCode,
				fullAltCode.length
			)
			if (completions) {
				completions.sort((a, b) => b.required - a.required);
				isParamSelector = completions.some(completion => completion.name === '__type');
				return;
			}
			completions = [];
		}
	}

	function getFieldValue (name) {
		return value && value[name];
	}

	function getDefaultValue (name) {
		return defaultValue && defaultValue[name];
	}

	function handleChange (change) {
		editedValue = {
			...editedValue,
			...change
		}
		dispatch('change', editedValue);
	}

	$: editedValue = value;
	$: dataType && computeTypings();
</script>

<div>
{#each completions as completion (`${id}-${completion.name}`)}
	{#if !isParamSelector || ['__type', value.__type].includes(completion.name)}
		<ESField
			labelText={completion.name}
			required={isParamSelector
				? required
				: required && completion.required
			}
			dataType={completion.displayText}
			value={getFieldValue(completion.name)}
			defaultValue={getDefaultValue(completion.name)}
			on:change={event => handleChange({[completion.name]: event.detail})}
			help={false}
		/>
	{/if}
{/each}
</div>

<style>
div {
	padding-left: 1em;
	border-left: 1px solid lightgray;
}
</style>
