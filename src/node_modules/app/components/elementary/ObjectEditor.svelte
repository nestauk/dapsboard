<script>
	import { createEventDispatcher } from 'svelte';
	import { getTypings } from 'app/elasticsearch/utils/aggParams';
	import { is_xor } from 'app/elasticsearch/types/genericTypes';
	import TypedField from 'app/components/elementary/TypedField.svelte';
	import { safeGetKeyOf } from 'svizzle/utils/obj-[string-any]';

	const dispatch = createEventDispatcher();

	export let typeObject;
	export let editedValue = null;
	export let id = null;
	export let value = null;
	export let required = false;

	let aggParamsInfo = [];
	let isParamSelector = false;

	const getFieldValue = safeGetKeyOf(value);

	function handleChange (change) {
		editedValue = {
			...editedValue,
			...change
		}
		dispatch('change', editedValue);
	}

	$: editedValue = value;
	$: aggParamsInfo = getTypings(typeObject);
	$: isParamSelector = is_xor(typeObject);
</script>

<div>
{#each aggParamsInfo as paramInfo (`${id}-${paramInfo.name}`)}
	{#if !isParamSelector
		|| ['selection', value?.selection].includes(paramInfo.name)
	}
		<TypedField
			labelText={paramInfo.name}
			required={isParamSelector
				? required
				: required && paramInfo.required
			}
			dataType={paramInfo.displayText}
			typeObject={paramInfo.type}
			value={getFieldValue(paramInfo.name)}
			on:change={event => handleChange({[paramInfo.name]: event.detail})}
			help={false}
		/>
	{/if}
{/each}
</div>

<style>
div {
	padding-left: 1em;
	border-left: 1px solid lightgray;
}
</style>
