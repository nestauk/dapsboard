<script context='module'>
    let datasetTypings;
</script>

<script>
    import { createEventDispatcher } from 'svelte';
    import { getCompletions } from 'app/tsservices';
	import { request } from 'app/net';

	import ESField from './ElasticSearchField.svelte';
	
	const dispatch = createEventDispatcher();

	export let id = null;
	export let dataType;
	export let required = false;
	export let value = null;
    export let defaultValue = null;
    export let editedValue = null;

    let completions = [];

    async function computeTypings () {
        if ('ts' in window) {
            if (!datasetTypings) {
                datasetTypings = await request(
                    'GET',
                    '/dsl/datasets.ts',
                    {type:'text'}
                );
            }

            const code = `const obj: ${dataType} = {};`;
            const fullCode = datasetTypings + code;
            completions = getCompletions(
                fullCode,
                fullCode.lastIndexOf('{') + 1
            )
            if (completions) {
                completions.sort((a, b) => b.required - a.required);
                return;
            }
            const altCode = `const obj: ${dataType} = '`;
            const fullAltCode = datasetTypings + altCode;
            completions = getCompletions(
                fullAltCode,
                fullAltCode.length 
            )
            if (completions) {
                completions.sort((a, b) => b.required - a.required);
                return;
            }
            completions = [];
        }
    }

    function getFieldValue (name) {
		return value && value[name];
	}

	function getDefaultValue (name) {
		return defaultValue && defaultValue[name];
    }
    
	function handleChange (change) {
        editedValue = {
            ...editedValue,
            ...change
        }
		dispatch('change', editedValue);
	}

    $: dataType && computeTypings();
</script>

<div>
{#each completions as completion (`${id}-${completion.name}`)}
    <ESField
        labelText={completion.name}
        required={completion.required}
        dataType={completion.displayText}
        value={getFieldValue(completion.name)}
        defaultValue={getDefaultValue(completion.name)}
        on:change={event => handleChange({[completion.name]: event.detail})}
        help={false}
    />
{/each}
</div>

<style>
div {
    padding-left: 1em;
    border-left: 1px solid black;
}
</style>