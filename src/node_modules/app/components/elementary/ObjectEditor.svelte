<script>
	import { createEventDispatcher } from 'svelte';
	import {getTypings} from 'app/elasticsearch/utils/aggParams';

	import TypedField from 'app/components/elementary/TypedField.svelte';
	import { isKeyValue } from '@svizzle/utils';
	import { safeGetKeyOf } from 'svizzle/utils/obj-[string-any]';

	const dispatch = createEventDispatcher();

	export let typeObject;
	export let editedValue = null;
	export let id = null;
	export let value = null;
	export let required = false;

	let aggParamsInfo = [];
	let isParamSelector = false;

	const isNameType = isKeyValue(['name', '__selected']);

	const getFieldValue = safeGetKeyOf(value);

	function handleChange (change) {
		editedValue = {
			...editedValue,
			...change
		}
		dispatch('change', editedValue);
	}

	$: editedValue = value;
	$: aggParamsInfo = getTypings(typeObject);
	$: isParamSelector = aggParamsInfo.some(isNameType);
</script>

<div>
{#each aggParamsInfo as paramInfo (`${id}-${paramInfo.name}`)}
	{#if !['__optional','__shape'].includes(paramInfo.name)
		&& !isParamSelector
		|| ['__selected', value?.__selected].includes(paramInfo.name)
	}
		<TypedField
			labelText={paramInfo.name}
			required={isParamSelector
				? required
				: required && paramInfo.required
			}
			dataType={paramInfo.displayText}
			typeObject={paramInfo.type}
			value={getFieldValue(paramInfo.name)}
			on:change={event => handleChange({[paramInfo.name]: event.detail})}
			help={false}
		/>
	{/if}
{/each}
</div>

<style>
div {
	padding-left: 1em;
	border-left: 1px solid lightgray;
}
</style>
