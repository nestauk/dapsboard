<script>
	// eslint-disable-next-line node/no-unpublished-import
	import { createEventDispatcher } from 'svelte';
	import { computeParamInfo, extractBaseType } from 'app/elasticsearch';

	import ESField from './ElasticSearchField.svelte';
	import { isKeyValue } from '@svizzle/utils';

	const dispatch = createEventDispatcher();

	export let typeObject;
	export let defaultValue = null;
	export let editedValue = null;
	export let id = null;
	export let value = null;
	export let required = false;

	let completions = [];
	let isParamSelector = false;

	const isNameType = isKeyValue(['name', '__type']);

	function computeTypings () {
		let type = typeObject;
		type = extractBaseType(type);
		if (Array.isArray(type)) {
			throw new Error('ObjectEditor: Type unions not supported.');
		}
		completions = computeParamInfo(type);
		completions.sort((a, b) => b.required - a.required);
		isParamSelector = completions.some(isNameType);
	}

	function getFieldValue (name) {
		return value && value[name];
	}

	function getDefaultValue (name) {
		return defaultValue && defaultValue[name];
	}

	function handleChange (change) {
		editedValue = {
			...editedValue,
			...change
		}
		dispatch('change', editedValue);
	}

	$: editedValue = value;
	$: typeObject && computeTypings();
</script>

<div>
{#each completions as completion (`${id}-${completion.name}`)}
	{#if !isParamSelector || ['__type', value.__type].includes(completion.name)}
		<ESField
			labelText={completion.name}
			required={isParamSelector
				? required
				: required && completion.required
			}
			dataType={completion.displayText}
			typeObject={completion.type}
			value={getFieldValue(completion.name)}
			defaultValue={getDefaultValue(completion.name)}
			on:change={event => handleChange({[completion.name]: event.detail})}
			help={false}
		/>
	{/if}
{/each}
</div>

<style>
div {
	padding-left: 1em;
	border-left: 1px solid lightgray;
}
</style>
